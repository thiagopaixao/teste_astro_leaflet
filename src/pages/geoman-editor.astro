---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Editor Geoman">
  <div id="map" style="width: 100%; height: 100vh;"></div>

  <script>
    import L from 'leaflet';
    import '@geoman-io/leaflet-geoman-free';

    const urlParams = new URLSearchParams(window.location.search);
    const lat = parseFloat(urlParams.get('lat')) || -14.235004;
    const lng = parseFloat(urlParams.get('lng')) || -51.92528;
    const zoom = parseInt(urlParams.get('zoom')) || 4;
    const geojsonString = urlParams.get('geojson') || '{}';

    const map = L.map('map').setView([lat, lng], zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    map.pm.addControls({
      position: 'topleft',
      drawCircle: false,
    });

    try {
      const geojsonData = JSON.parse(geojsonString);
      L.geoJSON(geojsonData).addTo(drawnItems);
    } catch (error) {
      console.error('Erro ao analisar GeoJSON:', error);
    }

    map.on('pm:create', updateParent);
    map.on('pm:remove', updateParent);
    map.on('moveend', updateParent);

    function updateParent() {
      const center = map.getCenter();
      const newValue = {
        latitude: center.lat,
        longitude: center.lng,
        zoom: map.getZoom(),
        geojson: JSON.stringify(drawnItems.toGeoJSON())
      };
      
      window.opener.postMessage(newValue, '*');
    }
  </script>
</Layout>
